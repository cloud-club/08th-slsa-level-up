---
# 정책 1: Root 권한으로 실행 금지
# 목적: 컨테이너 탈취 시 호스트 침해 방지
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: disallow-root-user
  annotations:
    policies.kyverno.io/title: Disallow Root User
    policies.kyverno.io/severity: critical
    policies.kyverno.io/description: >-
      컨테이너가 root 사용자(UID 0)로 실행되는 것을 방지합니다.
      공격자가 컨테이너를 탈취하더라도 호스트 침해 위험을 최소화합니다.
spec:
  validationFailureAction: enforce
  background: true
  rules:
  - name: check-runAsNonRoot
    match:
      any:
      - resources:
          kinds:
          - Pod
    validate:
      message: "컨테이너는 root 사용자로 실행될 수 없습니다. securityContext.runAsNonRoot를 true로 설정하세요."
      pattern:
        spec:
          containers:
          - securityContext:
              runAsNonRoot: true

---
# 정책 2: 리소스 제한 필수
# 목적: 리소스 고갈로 인한 노드 다운 방지
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: require-resource-limits
  annotations:
    policies.kyverno.io/title: Require Resource Limits
    policies.kyverno.io/severity: critical
    policies.kyverno.io/description: >-
      모든 컨테이너에 CPU와 메모리 제한을 설정하여
      단일 Pod가 노드 전체 리소스를 점유하는 것을 방지합니다.
spec:
  validationFailureAction: enforce
  background: true
  rules:
  - name: check-container-resources
    match:
      any:
      - resources:
          kinds:
          - Pod
    validate:
      message: "컨테이너는 CPU와 메모리 limits를 반드시 설정해야 합니다."
      pattern:
        spec:
          containers:
          - resources:
              limits:
                memory: "?*"
                cpu: "?*"

---
# 정책 3: 호스트 네임스페이스 공유 금지
# 목적: 컨테이너 격리 보장
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: disallow-host-namespaces
  annotations:
    policies.kyverno.io/title: Disallow Host Namespaces
    policies.kyverno.io/severity: high
    policies.kyverno.io/description: >-
      호스트의 네트워크, PID, IPC 네임스페이스 공유를 금지하여
      컨테이너 격리를 보장합니다.
spec:
  validationFailureAction: enforce
  background: true
  rules:
  - name: check-host-namespaces
    match:
      any:
      - resources:
          kinds:
          - Pod
    validate:
      message: "호스트 네임스페이스(네트워크, PID, IPC) 공유는 금지됩니다."
      pattern:
        spec:
          =(hostNetwork): false
          =(hostPID): false
          =(hostIPC): false

---
# 정책 4: latest 태그 금지
# 목적: 재현 가능한 배포 보장
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: disallow-latest-tag
  annotations:
    policies.kyverno.io/title: Disallow Latest Tag
    policies.kyverno.io/severity: high
    policies.kyverno.io/description: >-
      'latest' 태그 사용을 금지하여 이미지 버전을 명시적으로 관리합니다.
      재현 가능한 빌드와 안정적인 배포를 보장합니다.
spec:
  validationFailureAction: enforce
  background: true
  rules:
  - name: check-image-tag
    match:
      any:
      - resources:
          kinds:
          - Pod
    validate:
      message: "이미지 태그로 'latest'는 사용할 수 없습니다. 명시적인 버전을 지정하세요."
      pattern:
        spec:
          containers:
          - image: "!*:latest"
